/*!
 * Start Bootstrap - SB Admin 2 v4.1.3 (https://startbootstrap.com/theme/sb-admin-2)
 * Copyright 2013-2025 Start Bootstrap
 * Licensed under MIT (https://github.com/StartBootstrap/startbootstrap-sb-admin-2/blob/master/LICENSE)
 */

document.addEventListener("DOMContentLoaded",function(){console.log("Initializing simulation...");let c=document.getElementById("start-simulation"),u=document.getElementById("simulation-type"),m=document.getElementById("data-frequency"),a=document.getElementById("simulation-status"),h=document.getElementById("data-mode"),p=document.getElementById("connection-status");if(c&&u&&m&&h){let o=null,s=!1,d=null,n=null;var t=document.getElementById("start-prediction");let e=document.getElementById("consent-popup");var g=document.getElementById("consent-accept"),y=document.getElementById("consent-decline");let r=document.getElementById("prediction-results"),i=document.getElementById("emergency-popup");var f=document.getElementById("emergency-close");c.addEventListener("click",()=>{var e,t,a,r;s?(console.log("Stopping simulation"),clearInterval(o),s=!1,c.textContent="Start Simulation",x("Health Predictions stopped","text-muted"),n&&(n.disconnect(),n=null,v("Disconnected","text-danger"))):(a=u.value,r=Math.max(1e3,parseInt(m.value)||5e3),e=h.value,t=a,a=r,r=e,console.log(`Starting ${t} simulation (${a}ms) in ${r} mode`),s=!0,c.textContent="Stop Simulation",x(`Running ${t} Health Predictions`,"text-success"),"real_device"===r&&(n=io("http://localhost:5001"),v("Connecting...","text-warning"),n.on("connect",()=>{console.log("Connected to WebSocket server"),v("Connected","text-success")}),n.on("disconnect",()=>{console.log("Disconnected from WebSocket server"),v("Disconnected","text-danger")}),n.on("connection_status",e=>{console.log("Connection status:",e.status),v(e.status,"connected"===e.status?"text-success":"text-danger")}),n.on("update_health_metrics",e=>{console.log("Received health metrics:",e);var t=e,e=(document.querySelectorAll(".card.border-left-success .h5").forEach(e=>e.textContent=t.blood_pressure_systolic+"/"+t.blood_pressure_diastolic),document.querySelectorAll(".card.border-left-info .h5").forEach(e=>e.textContent=t.spo2),document.querySelectorAll(".card.border-left-warning .h5").forEach(e=>e.textContent=t.temperature),b(".card.border-left-success",t.blood_pressure_systolic,l.bloodPressureSystolic,"mmHg"),b(".card.border-left-info",t.spo2,l.spo2,"SpO2%"),b(".card.border-left-warning",t.temperature,l.temperature,"°C"),{heartRate:d.heartRate,bloodPressureSystolic:t.blood_pressure_systolic,bloodPressureDiastolic:t.blood_pressure_diastolic,spo2:t.spo2,glucose:d.glucose,temperature:parseFloat(t.temperature)});"function"==typeof addDataPoint&&addDataPoint(new Date,e),d={heartRate:d.heartRate,bloodPressureSystolic:t.blood_pressure_systolic,bloodPressureDiastolic:t.blood_pressure_diastolic,spo2:t.spo2,temperature:t.temperature,glucose:d.glucose}})),C(t),o=setInterval(()=>{C(t)},a))}),t&&e&&g&&y&&r&&i&&f?(t.addEventListener("click",()=>{e.classList.remove("d-none")}),y.addEventListener("click",()=>{e.classList.add("d-none")}),g.addEventListener("click",()=>{e.classList.add("d-none");{console.log("Starting prediction process..."),r.innerHTML='<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Fetching prediction...</div>';let a=(()=>{try{var e,t=document.querySelector(".card.border-left-primary"),a=document.querySelector(".card.border-left-success"),r=document.querySelector(".card.border-left-info"),o=document.querySelector(".card.border-left-warning"),s=parseInt(t.querySelector(".h5").textContent),[n,i]=a.querySelector(".h5").textContent.split("/").map(Number),l=parseInt(r.querySelector(".h5").textContent),c=parseFloat(o.querySelector(".h5").textContent);return isNaN(s)||isNaN(n)||isNaN(i)||isNaN(l)||isNaN(c)?(console.error("Failed to parse health data from cards."),null):(e=d?d.glucose:null,{heart_rate:s,blood_pressure_systolic:n,blood_pressure_diastolic:i,spo2:l,temperature:c,glucose:e})}catch(e){return console.error("Error reading health data from UI:",e),null}})();a?(console.log("Collected health data:",a),fetch("/predict",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(e=>{if(e.ok)return e.json();throw new Error("HTTP error! status: "+e.status)}).then(e=>{if(console.log("Received prediction data:",e),e.error)console.error("Prediction API Error:",e.error),r.innerHTML=`<div class="alert alert-danger">Error fetching prediction: ${e.error}</div>`;else{var t=e.predictions;if(t&&0!==t.length){let n='<ul class="list-group list-group-flush">';t.forEach(e=>{var{condition:e,probability:t,severity:a}=e;let r="fas fa-question-circle",o="list-group-item-secondary",s="Info";switch(e.toLowerCase()){case"hypertension":case"hypotension":r="fas fa-heartbeat";break;case"hyperglycemia":case"hypoglycemia":r="fas fa-tint";break;case"hypoxia":case"hypoxemia":r="fas fa-lungs";break;case"tachycardia":case"bradycardia":r="fas fa-tachometer-alt";break;case"fever":r="fas fa-thermometer-full";break;case"hypothermia":r="fas fa-thermometer-empty"}switch(a.toLowerCase()){case"low":o="list-group-item-success",s="Low Risk";break;case"medium":o="list-group-item-warning",s="Medium Risk";break;case"high":o="list-group-item-danger",s="High Risk";break;case"critical":o="list-group-item-danger font-weight-bold",s="Critical Risk"}n+=`
                <li class="list-group-item d-flex justify-content-between align-items-center ${o}">
                    <div>
                        <i class="${r} mr-2"></i>
                        <strong>${e}</strong>
                    </div>
                    <span class="badge badge-primary badge-pill">${(100*t).toFixed(1)}%</span>
                    <span class="badge badge-secondary">${s}</span>
                </li>
            `}),n+="</ul>",r.innerHTML=n;t=t.find(e=>"critical"===e.severity);t&&(e=>{var t=i.querySelector(".emergency-content p");t&&(t.textContent=`Critical health risk detected: ${e}. Please seek immediate medical attention or call emergency services.`),i.classList.add("d-none"),i.classList.remove("d-none")})(t.condition)}else r.innerHTML='<div class="alert alert-info">No specific conditions predicted at this time.</div>';updateHealthInsights(e.predictions,a)}}).catch(e=>{console.error("Fetch Error:",e),r.innerHTML=`<div class="alert alert-danger">Error: Unable to connect to the prediction service. ${e.message}</div>`})):r.innerHTML='<div class="alert alert-warning">Could not read current health data.</div>'}}),f.addEventListener("click",()=>{i.classList.add("d-none")})):console.error("One or more prediction UI elements are missing!");let l={heartRate:{normal:[60,100],medium:[50,110],high:[40,120]},bloodPressureSystolic:{normal:[90,120],medium:[80,130],high:[70,140]},bloodPressureDiastolic:{normal:[60,80],medium:[50,90],high:[40,100]},spo2:{normal:[95,100],medium:[92,95],high:[88,92]},temperature:{normal:[36.1,37.2],medium:[37.3,38],high:[38.1,39]},glucose:{normal:[70,140],medium:[141,180],high:[181,250]}};function b(t,a,r,o){t=document.querySelector(t);if(t){t=t.querySelector(".text-xs.text-success");if(t){var{status:a,className:r}=(a=a)>=(r=r).normal[0]&&a<=r.normal[1]?{status:"Normal",className:"text-success"}:a>=r.medium[0]&&a<=r.medium[1]?{status:"Slightly Elevated",className:"text-warning"}:a>=r.high[0]&&a<=r.high[1]?{status:"Elevated",className:"text-danger"}:{status:"Critical",className:"text-danger"};let e="";e="text-success"===r?"#2ecc71":"text-warning"===r?"#ffcb00":"#ed5565",t.innerHTML=`<i class="fas fa-arrow-right mr-1" style="font-size: .7rem; color: ${e}"></i> <span style="color: ${e}; font-size: .7rem;">${a} (${o})</span>`}}}function v(e,t){p&&(p.textContent="> Connection Status: "+e,p.className=t)}function C(e){let t={heartRate:w(60,100,"Elevated Heart Rate"===e?[100,120]:null),bloodPressureSystolic:w(110,130,"Low Blood Pressure"===e?[80,100]:null),bloodPressureDiastolic:w(70,90,"Low Blood Pressure"===e?[50,70]:null),spo2:w(95,100),glucose:w(70,140,"High Glucose"===e?[150,200]:null),temperature:w(36,37.5,"Elevated Temperature"===e?[37.6,39]:null,!0)};d=t,document.querySelectorAll(".card.border-left-primary .h5").forEach(e=>e.textContent=t.heartRate),document.querySelectorAll(".card.border-left-success .h5").forEach(e=>e.textContent=t.bloodPressureSystolic+"/"+t.bloodPressureDiastolic),document.querySelectorAll(".card.border-left-info .h5").forEach(e=>e.textContent=t.spo2),document.querySelectorAll(".card.border-left-warning .h5").forEach(e=>e.textContent=t.temperature),b(".card.border-left-primary",t.heartRate,l.heartRate,"BPM"),b(".card.border-left-success",t.bloodPressureSystolic,l.bloodPressureSystolic,"mmHg"),b(".card.border-left-info",t.spo2,l.spo2,"SpO2%"),b(".card.border-left-warning",t.temperature,l.temperature,"°C");var[e,a]=[t.bloodPressureSystolic,t.bloodPressureDiastolic],e={heartRate:t.heartRate,bloodPressureSystolic:e,bloodPressureDiastolic:a,spo2:t.spo2,glucose:t.glucose,temperature:parseFloat(t.temperature)};"function"==typeof addDataPoint&&addDataPoint(new Date,e)}function x(e,t){a&&(a.textContent="> "+e,a.className=t)}function w(e,t,a=null,r=!1){a=a||[e,t];return r?(Math.random()*(a[1]-a[0])+a[0]).toFixed(1):Math.floor(Math.random()*(a[1]-a[0]+1))+e}console.log("Simulation ready")}else console.error("Missing required elements")});let healthConditionExplanations={Hypertension:"There is a chance of elevated blood pressure, which may indicate hypertension. Monitoring is advised.",Hypoxia:"There is a chance of reduced oxygen levels, which may indicate hypoxia. Consider consulting a healthcare professional.",Hyperglycemia:"There is a chance of elevated blood sugar levels, which may indicate hyperglycemia. Dietary adjustments and monitoring are recommended.",Fever:"There is a chance of elevated body temperature, which may indicate a fever. Rest and hydration are advised.",Bradycardia:"There is a chance of a slow heart rate, which may indicate bradycardia. Further evaluation may be necessary.",Tachycardia:"There is a chance of a fast heart rate, which may indicate tachycardia. Avoiding stimulants and monitoring are recommended.",Hypothermia:"There is a chance of reduced body temperature, which may indicate hypothermia. Warming up and seeking medical advice are advised.",Hyperthermia:"There is a chance of very high body temperature, which may indicate hyperthermia. Immediate medical attention is required.",Hypoglycemia:"There is a chance of low blood sugar levels, which may indicate hypoglycemia. Consuming a small amount of sugar is recommended.",Normal:"All current readings appear within acceptable ranges. No notable health risks detected at this time.","Unable to provide a prediction with current data. Please check input values.":" Unable to provide an insight with current data. Please check input values."},conditionDetails={Hypertension:{iconClass:"fas fa-heartbeat",colorClass:"list-group-item-warning"},Hypoxia:{iconClass:"fas fa-lungs",colorClass:"list-group-item-danger"},Hyperglycemia:{iconClass:"fas fa-tint",colorClass:"list-group-item-warning"},Fever:{iconClass:"fas fa-thermometer-full",colorClass:"list-group-item-warning"},Bradycardia:{iconClass:"fas fa-tachometer-alt",colorClass:"list-group-item-warning"},Tachycardia:{iconClass:"fas fa-tachometer-alt",colorClass:"list-group-item-warning"},Hypothermia:{iconClass:"fas fa-thermometer-empty",colorClass:"list-group-item-danger"},Hyperthermia:{iconClass:"fas fa-thermometer-full",colorClass:"list-group-item-danger"},Hypoglycemia:{iconClass:"fas fa-tint",colorClass:"list-group-item-warning"}};function updateHealthInsights(e,t){var a=document.getElementById("health-insights");if(a){let r="";e&&0!==e.length?(r+="<b>Contextual Insights:</b><br>",e.forEach(e=>{var e=e.condition,t=healthConditionExplanations[e],a=conditionDetails[e]||{iconClass:"fas fa-question-circle",colorClass:"list-group-item-secondary"};r+=t?`<p><i class="${a.iconClass} mr-2 ${a.colorClass}"></i>${t}</p>`:`<p><i class="${a.iconClass} mr-2 ${a.colorClass}"></i>Possible risk of ${e}. Consult a healthcare professional.</p>`})):r="<p>All current readings appear within acceptable ranges. No notable health risks detected at this time.</p>",a.innerHTML=r}else console.error("Health Insights container not found.")}